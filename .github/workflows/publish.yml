name: Publish to Maven Central

on:
  release:
    types: [created]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Extract version from tag
      id: extract_version
      run: |
        TAG_NAME="${{ github.event.release.tag_name }}"
        if [[ "$TAG_NAME" =~ ^v(.+)$ ]]; then
          echo "version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
        else
          echo "version=${TAG_NAME}" >> $GITHUB_OUTPUT
        fi
        echo "Extracted version: $(grep version $GITHUB_OUTPUT)"

    - name: Build release AAR
      run: ./gradlew assembleRelease
      env:
        RELEASE_VERSION: ${{ steps.extract_version.outputs.version }}

    - name: Run tests
      run: ./gradlew test

    - name: Publish to Maven Central
      run: ./gradlew publishAndReleaseToMavenCentral --no-configuration-cache
      env:
        RELEASE_VERSION: ${{ steps.extract_version.outputs.version }}
        ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
        ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
        ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_PRIVATE_KEY }}
        ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_PASSPHRASE }}

    - name: Publish summary
      run: |
        echo "## Published to Maven Central" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ steps.extract_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "- \`com.blainks:blaink:${{ steps.extract_version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`com.blainks:blaink-core:${{ steps.extract_version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`com.blainks:blaink-push:${{ steps.extract_version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Usage:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`kotlin" >> $GITHUB_STEP_SUMMARY
        echo "implementation(\"com.blainks:blaink:${{ steps.extract_version.outputs.version }}\")" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
